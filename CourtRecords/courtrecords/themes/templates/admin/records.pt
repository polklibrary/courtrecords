<metal:page
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    use-macro="load: master.pt">
    
    
    <tal:block metal:fill-slot="header">
        - Editing Record
    </tal:block>
    
    
    <tal:block metal:fill-slot="css">
    </tal:block>
    
    <tal:block metal:fill-slot="js">
        <script type="text/javascript" src="${request.static_url('courtrecords:themes/js/scaffold.js')}"></script>
        <script type="text/javascript" src="${request.static_url('courtrecords:themes/js/manage.js')}"></script>
        <script>
            $(document).ready(function(){
                QuickSearch.init();
                $(document).tooltip({content: function(e){ return $(this).attr('data-tooltip'); }, items:'[data-tooltip]', tooltipClass: 'tooltip'});
                
                // Fields to remember only on new entries
                if (document.location.href.indexOf('/records/new') != -1) {
                    StickyFields.stickify('#record-case-county');
                    StickyFields.stickify('#record-case-court');
                    StickyFields.stickify('#record-case-callnumber');
                    StickyFields.stickify('#record-case-container');
                    StickyFields.stickify('#record-case-archives');
                    StickyFields.stickify('#record-case-actiontype');
                    StickyFields.load_any_stickies();
                }
                
                $('#manage-records-table input[type="button"]').click(function(){
                    var url = $(this).attr('data-url');
                    $.post(url, function(data) {
                        console.log(data);
                    });
                });
            
                var new_rows = 0;
                $('#add-row').click(function(){
                    var html = $('#row-template tbody').html();
                    html = html.replace(/{index}/g, new_rows);
                    $('#manage-records-table tbody').append(html);
                    
                    // Prep the removal button
                    $('#manage-records-table .new-removal').each(function(){
                        $(this).click(function(){
                            $(this).parents('tr').remove();
                        });
                        $(this).removeClass('new-removal');
                    });
                    
                    // Increment temporary ID holder
                    new_rows++;
                    
                });
                
                if ('${case_id}' == 'new')
                    $('#add-row').trigger('click');
                    
            });
        </script>
    </tal:block>
     
    <tal:block metal:fill-slot="content">
        
        <div class="button-pagination hide">
            <a class="button prev" href="">Previous Case Number</a>
            <a class="button next" href="">Next Case Number</a>
        </div>
        
        <form id="manage-records" action="" method="post" >
            
            <h2>Case Information</h2>
            <div id="manage-records-case" tal:condition="case" class="row">
                <div class="col1 left">

                    <label for="record-case-actiontype">Action Type:</label>
                    <select id="record-case-actiontype" name="edit.Cases.actiontype.${case.Cases.id}">
                        <option tal:repeat="at actiontypes" tal:attributes="selected (at.id == case.Cases.actiontype)" value="${at.id}">
                            ${at.actiontype}
                        </option>
                    </select>

                    <label for="record-case-number">Case Number:</label>
                    <input id="record-case-number" type="text" value="${case.Cases.case_number}" name="edit.Cases.case_number.${case.Cases.id}" />

                    <label for="record-case-container">Container:</label>
                    <select id="record-case-container" name="edit.Cases.container.${case.Cases.id}">
                        <option tal:repeat="co containers" tal:attributes="selected (co.id == case.Cases.container)" value="${co.id}">
                            ${co.container}
                        </option>
                    </select>
                    
                    <label for="record-case-container-type">Container Number:</label>
                    <input id="record-case-container-type" type="text" value="${case.Cases.container_number}" name="edit.Cases.container_number.${case.Cases.id}" />
                    
                    <label for="record-case-subset">Subset (Folder/Page/Drawer #):</label>
                    <input id="record-case-subset" type="text" value="${case.Cases.subset}" name="edit.Cases.subset.${case.Cases.id}" />
                    
                    <label for="record-case-callnumber">Call Number:</label>
                    <select id="record-case-callnumber" name="edit.Cases.call_number.${case.Cases.id}">
                        <option tal:repeat="cn call_numbers" tal:attributes="selected (cn.id == case.Cases.call_number)" value="${cn.id}">
                            ${cn.call_number}
                        </option>
                    </select>

                    <label for="record-case-eyear">Exact Date:</label>
                    <input id="record-case-eyear" type="text" value="${case.Cases.year_text}" name="edit.Cases.year_text.${case.Cases.id}" data-tooltip="
                    <b>Exact Date - Allowed Formats:</b> <br />  
                    1/21/1955<br /> 1955/1/21<br /> 1-21-1955<br /> 
                    1955-1-21<br /> 1900-1920<br /> 1900,1920<br /> 
                    1955<br /> 
                    <i>Formats above will auto populate the 'Year' field for sorting.</i>
                    "   />
                    
                    
                </div>
                
                <div class="col2 left">
                    <label for="record-case-notes">Notes:</label>
                    <textarea id="record-case-notes" name="edit.Cases.notes.${case.Cases.id}">${case.Cases.notes}</textarea>
                    
                    <label for="record-case-archives">Archives:</label>
                    <select id="record-case-archives" name="edit.Cases.archive.${case.Cases.id}">
                        <option tal:repeat="arc archives" tal:attributes="selected (arc.id == case.Archives.id)" value="${arc.id}">
                            ${arc.name}
                        </option>
                    </select>
                                        
                    <label for="record-case-county">County:</label>
                    <select id="record-case-county" name="edit.Cases.county.${case.Cases.id}">
                        <option tal:repeat="co counties" tal:attributes="selected (co.id == case.Cases.county)" value="${co.id}">
                            ${co.county}
                        </option>
                    </select>
                    
                    <label for="record-case-court">Court:</label>
                    <select id="record-case-court" name="edit.Cases.court.${case.Cases.id}">
                        <option tal:repeat="co courts" tal:attributes="selected (co.id == case.Cases.court)" value="${co.id}">
                            ${co.court}
                        </option>
                    </select>                    
                    
                </div>
                
                <div class="clear"></div>
                
            </div>
            
            
            <div id="manage-records-case" tal:condition="not: case" class="row">
                <div class="col1 left">
                
                    <label for="record-case-actiontype">Action Type:</label>
                    <select id="record-case-actiontype" name="new.Cases.actiontype.0">
                        <option tal:repeat="at actiontypes" value="${at.id}">
                            ${at.actiontype}
                        </option>
                    </select>

                    <label for="record-case-number">Case Number:</label>
                    <input id="record-case-number" type="text" value="" name="new.Cases.case_number.0" />

                    <label for="record-case-container">Container:</label>
                    <select id="record-case-container" name="new.Cases.container.0">
                        <option tal:repeat="co containers" value="${co.id}">
                            ${co.container}
                        </option>
                    </select>
                    
                    <label for="record-case-container-type">Container Number:</label>
                    <input id="record-case-container-type" type="text" value="" name="new.Cases.container_number.0" />
                    
                    <label for="record-case-subset">Subset (Folder/Page/Drawer #):</label>
                    <input id="record-case-subset" type="text" value="" name="new.Cases.subset.0" />
                    
                    <label for="record-case-callnumber">Call Number:</label>
                    <select id="record-case-callnumber" name="new.Cases.call_number.0">
                        <option tal:repeat="cn call_numbers" value="${cn.id}">
                            ${cn.call_number}
                        </option>
                    </select>

  
                    <label for="record-case-year">Exact Date:</label>
                    <input id="record-case-year" type="text" value="" name="new.Cases.year_text.0" />
                    
                </div>
                
                <div class="col2 left">
                
                    <label for="record-case-notes">Notes:</label>
                    <textarea id="record-case-notes" name="new.Cases.notes.0"></textarea>
                    
                    <label for="record-case-archives">Archives:</label>
                    <select id="record-case-archives" name="new.Cases.archive.0">
                        <option tal:repeat="arc archives" value="${arc.id}">
                            ${arc.name}
                        </option>
                    </select>
                                        
                    <label for="record-case-county">County:</label>
                    <select id="record-case-county" name="new.Cases.county.0">
                        <option tal:repeat="co counties" value="${co.id}">
                            ${co.county}
                        </option>
                    </select>
                    
                    <label for="record-case-court">Court:</label>
                    <select id="record-case-court" name="new.Cases.court.0">
                        <option tal:repeat="co courts" value="${co.id}">
                            ${co.court}
                        </option>
                    </select>                    
                    
                    
                </div>
                <div class="clear"></div>
            </div>
            
            
            <h2>Entities in case</h2>
            <div id="manage-records-entities" class="row">
                <table id="manage-records-table" class="tablesorter">
                    <thead>
                        <tr>
                            <th>Entity</th>
                            <th>Prefix</th>
                            <th>Last</th>
                            <th>First</th>
                            <th>Middle</th>
                            <th>Suffix</th>
                            <th>Alternate Name</th>
                            <th>Role</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr tal:repeat="entity entities">
                            <td><input type="text" value="${entity.Entities.entity}" name="edit.Entities.entity.${entity.Entities.id}" /></td>
                            <td>
                                <select name="edit.Entities.prefix.${entity.Entities.id}">
                                    <option tal:repeat="pr prefixs" tal:attributes="selected (pr.id == entity.Entities.prefix)" value="${pr.id}">
                                        ${pr.prefix} 
                                    </option>
                                </select>
                            </td>
                            <td><input type="text" value="${entity.Entities.lastname}" name="edit.Entities.lastname.${entity.Entities.id}" /></td>
                            <td><input type="text" value="${entity.Entities.firstname}" name="edit.Entities.firstname.${entity.Entities.id}" /></td>
                            <td><input type="text" value="${entity.Entities.middlename}" name="edit.Entities.middlename.${entity.Entities.id}" /></td>
                            <td>
                                <select name="edit.Entities.suffix.${entity.Entities.id}">
                                    <option tal:repeat="su suffixs" tal:attributes="selected (su.id == entity.Entities.suffix)" value="${su.id}">
                                        ${su.suffix}
                                    </option>
                                </select>
                            </td>
                            <td><input type="text" value="${entity.Entities.alternatename}" name="edit.Entities.alternatename.${entity.Entities.id}" /></td>
                            <td>
                                <select name="edit.Entities.role.${entity.Entities.id}">
                                    <option tal:repeat="ro roles" tal:attributes="selected (ro.id == entity.Entities.role)" value="${ro.id}">
                                        ${ro.role}
                                    </option>
                                </select>
                            </td>
                            <td>
                                <input class="button red warning" type="button" data-url="${request.application_url}/manage/data/Entities/delete/${entity.Entities.id}?back=${request.url}" value="Remove" />
                            </td>
                        </tr>
                    </tbody>
                    
                </table>
                
                
                <div class="buttons">
                    <input id="add-row" class="button green" type="button" value="Add another entity" />
                </div>
                
            </div>

            <div class="buttons">
                <input class="button purple manage-quick-search-button" type="button" value="Quick Search" />
                <input class="button" type="submit" value="Save Record" name="edit.Form.submit.save" />
                <input class="button" type="submit" value="Save Record (Add another)" name="edit.Form.submit.savenext" />
                <a class="button red" href="${request.application_url}/manage/cases">Cancel</a>
            </div>
        </form>

        
        <!-- template for new entity row -->
        <table id="row-template" class="hide">
            <tbody>
                <tr>
                    <td><input type="text" value="" name="new.Entities.entity.{index}" /></td>
                    <td>
                        <select name="new.Entities.prefix.{index}">
                            <option tal:repeat="pr prefixs" value="${pr.id}">
                                ${pr.prefix}
                            </option>
                        </select>
                    </td>
                    <td><input type="text" value="" name="new.Entities.lastname.{index}" /></td>
                    <td><input type="text" value="" name="new.Entities.middlename.{index}" /></td>
                    <td><input type="text" value="" name="new.Entities.firstname.{index}" /></td>
                    <td>
                        <select name="new.Entities.suffix.{index}">
                            <option tal:repeat="su suffixs" value="${su.id}">
                                ${su.suffix}
                            </option>
                        </select>
                    </td>
                    <td><input type="text" value="" name="new.Entities.alternatename.{index}" /></td>
                    <td>
                        <select name="new.Entities.role.{index}">
                            <option tal:repeat="ro roles" value="${ro.id}">
                                ${ro.role}
                            </option>
                        </select>
                    </td>
                    <td>
                        <input class="button red warning new-removal" type="button" value="Remove">
                    </td>
                </tr>
            </tbody>
        </table>
        
    </tal:block>
     
</metal:page>